<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --panel:#e0f2fe;
  --text:#0f172a;
  --accent:#3b82f6;
  --light:#e0f2fe;
  --danger:#ef4444;
  --success:#22c55e;
}
.dark{
  --bg:#020617;
  --card:#0f172a;
  --panel:#1e293b;
  --text:#e5e7eb;
  --light:#1e293b;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg);color:var(--text)}
.hidden{display:none}

/* LOGIN */
.login{
  height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#60a5fa,#38bdf8)
}
.login-box{
  background:var(--card);padding:40px;border-radius:20px;
  width:90%;max-width:360px
}
.login-box input{
  width:100%;padding:14px;margin:10px 0;
  border-radius:10px;border:1px solid #cbd5f5
}
.login-box button{
  width:100%;padding:14px;border:none;border-radius:12px;
  background:var(--accent);color:white;font-size:18px
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:0;height:100%;width:240px;
  background:var(--panel);padding:20px;
  transform:translateX(-100%);transition:.3s;z-index:20
}
.sidebar.show{transform:translateX(0)}
.sidebar button{
  width:100%;padding:12px;margin:8px 0;border:none;
  border-radius:12px;background:var(--light);
  font-size:16px;text-align:left
}
.toggle{
  margin-top:20px;padding:12px;border-radius:12px;
  background:var(--light);display:flex;justify-content:space-between
}
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  opacity:0;pointer-events:none;transition:.3s;z-index:15
}
#overlay.show{opacity:1;pointer-events:auto}

/* TOPBAR */
.topbar{
  display:flex;align-items:center;gap:10px;
  padding:14px 16px;
  background:linear-gradient(135deg,#60a5fa,#38bdf8);
  color:white
}
.menu{font-size:26px;cursor:pointer}
.topbar h3{flex:1;text-align:center;margin:0}

/* PAGE */
.page{display:none;padding:20px}
.page.active{display:block}

/* HOME CARDS */
.stat-card{
  background:var(--light);
  padding:18px;border-radius:18px;
  margin-bottom:16px;cursor:pointer
}
.stat-head{
  display:flex;justify-content:space-between;align-items:center
}
.big-num{font-size:34px;font-weight:800;color:var(--accent)}
.sub{opacity:.7}
.icon{transition:.3s}
.rotate{transform:rotate(180deg)}

.table-wrap{
  max-height:200px;overflow:auto;margin-top:12px
}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #cbd5f5;font-size:14px;text-align:left}
th{font-weight:700}

/* VISITORS */
.visitor-card{
  background:var(--light);
  padding:18px;border-radius:18px;
  margin-bottom:16px
}
.btn{
  padding:6px 10px;border:none;border-radius:8px;
  margin-right:6px;cursor:pointer
}
.block{background:#facc15}
.unblock{background:var(--success);color:white}
.delete{background:var(--danger);color:white}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginPage">
  <div class="login-box">
    <h2>Admin Login</h2>
    <input id="adminId" placeholder="Admin ID">
    <input id="adminPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="sidebar" id="sidebar">
  <button onclick="openPage('home')">üè† Home</button>
  <button onclick="openPage('visitors')">üë• Visitors</button>
  <button onclick="logout()">üö™ Logout</button>
  <div class="toggle">
    <span>üåô Dark Mode</span>
    <input type="checkbox" id="darkToggle">
  </div>
</div>
<div id="overlay"></div>

<div class="topbar">
  <span class="menu" onclick="toggleSidebar()">‚ò∞</span>
  <h3 id="title">Home</h3>
</div>

<!-- HOME -->
<div class="page active" id="home">
  <h2>Hello, Aayush üëã</h2>
  <p id="dateTime"></p>

  <div class="stat-card" onclick="toggleCard('blockedBox','icon1')">
    <div class="stat-head">
      <div>
        <div class="big-num" id="blockedCount">0</div>
        <div class="sub">Blocked Users</div>
      </div>
      <i id="icon1" class="fa-solid fa-chevron-down icon"></i>
    </div>
    <div class="table-wrap hidden" id="blockedBox"></div>
  </div>

  <div class="stat-card" onclick="toggleCard('totalBox','icon2')">
    <div class="stat-head">
      <div>
        <div class="big-num" id="totalCount">0</div>
        <div class="sub">Total Users</div>
      </div>
      <i id="icon2" class="fa-solid fa-chevron-down icon"></i>
    </div>
    <div class="table-wrap hidden" id="totalBox"></div>
  </div>

  <div class="stat-card">
    <div class="sub">Active Users</div>
    <div class="table-wrap" id="activeBox"></div>
  </div>
</div>

<!-- VISITORS -->
<div class="page" id="visitors"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, update } from
"https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* FIREBASE */
const fb=initializeApp({
  apiKey:"AIzaSyAht7TWN8NlbICl0VbEIuc19Mri7oPlXvc",
  databaseURL:"https://home-automation-89830-default-rtdb.firebaseio.com"
});
const db=getDatabase(fb);

/* LOGIN */
window.login=()=>{
  if(adminId.value==="aayush" && adminPass.value==="Aayush@1982"){
    loginPage.style.display="none";
    app.classList.remove("hidden");
    history.pushState({page:"home"},"","");
  }else alert("Invalid login");
};
window.logout=()=>location.reload();

/* PREVENT EXIT ‚Äì ALWAYS GO HOME */
window.onpopstate=()=>{
  openPage("home");
  history.pushState({page:"home"},"","");
};

/* SIDEBAR */
window.toggleSidebar=()=>{
  sidebar.classList.toggle("show");
  overlay.classList.toggle("show");
};
function closeSidebar(){
  sidebar.classList.remove("show");
  overlay.classList.remove("show");
}
overlay.onclick=closeSidebar;

/* NAV */
window.openPage=id=>{
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  title.innerText=id.charAt(0).toUpperCase()+id.slice(1);
  closeSidebar();
};

/* DATE & TIME */
setInterval(()=>{
  dateTime.innerText=new Date().toLocaleString("en-IN");
},1000);

/* TOGGLE CARD */
window.toggleCard=(box,icon)=>{
  document.getElementById(box).classList.toggle("hidden");
  document.getElementById(icon).classList.toggle("rotate");
  closeSidebar();
};

/* DATA */
onValue(ref(db,"visitors"),snap=>{
  let total=0,blocked=0;
  let bHTML=<table><tr><th>No</th><th>Name</th><th>Phone</th></tr>;
  let tHTML=<table><tr><th>No</th><th>Name</th><th>Phone</th></tr>;
  let aHTML=<table><tr><th>No</th><th>Name</th><th>Phone</th></tr>;
  let vHTML="";
  let i=1,j=1,k=1;

  snap.forEach(c=>{
    const d=c.val();
    total++;
    tHTML+=<tr><td>${j++}</td><td>${d.name}</td><td>${d.phone}</td></tr>;
    if(d.blocked){
      blocked++;
      bHTML+=<tr><td>${i++}</td><td>${d.name}</td><td>${d.phone}</td></tr>;
    }else{
      aHTML+=<tr><td>${k++}</td><td>${d.name}</td><td>${d.phone}</td></tr>;
    }

    const dt=d.lastVisit?new Date(d.lastVisit).toLocaleString("en-IN"):"‚Äî";

    vHTML+=`
      <div class="visitor-card">
        <b>${d.name}</b> (${d.phone})<br>
        Visits: ${d.visits||1}<br>
        Last Visit: ${dt}<br>
        Status: ${d.blocked?"Blocked":"Active"}<br><br>
        <button class="btn ${d.blocked?'unblock':'block'}"
          onclick="toggleBlock('${d.phone}',${d.blocked})">
          ${d.blocked?'Unblock':'Block'}
        </button>
        <button class="btn delete" onclick="deleteUser('${d.phone}')">Delete</button>
      </div>`;
  });

  blockedCount.innerText=blocked;
  totalCount.innerText=total;
  blockedBox.innerHTML=bHTML+</table>;
  totalBox.innerHTML=tHTML+</table>;
  activeBox.innerHTML=aHTML+</table>;
  visitors.innerHTML=vHTML;
});

/* BLOCK / DELETE */
window.toggleBlock=(phone,isBlocked)=>{
  update(ref(db,"visitors/"+phone),{blocked:!isBlocked});
  closeSidebar();
};
window.deleteUser=phone=>{
  if(confirm("Delete user permanently?")){
    remove(ref(db,"visitors/"+phone));
    remove(ref(db,"users/"+phone));
  }
};

/* DARK MODE */
if(localStorage.adminTheme==="dark"){
  document.body.classList.add("dark");
  darkToggle.checked=true;
}
darkToggle.onchange=()=>{
  document.body.classList.toggle("dark");
  localStorage.adminTheme=document.body.classList.contains("dark")?"dark":"light";
};

/* SWIPE LEFT + RIGHT ‚Üí HOME SAFE */
let sx=0,sy=0,ex=0,ey=0;
document.addEventListener("touchstart",e=>{
  sx=e.touches[0].clientX;
  sy=e.touches[0].clientY;
},{passive:true});

document.addEventListener("touchmove",e=>{
  if(Math.abs(e.touches[0].clientX-sx)>30){
    e.preventDefault();
  }
},{passive:false});

document.addEventListener("touchend",e=>{
  ex=e.changedTouches[0].clientX;
  ey=e.changedTouches[0].clientY;

  const dx=ex-sx;
  const dy=Math.abs(ey-sy);
  if(dy>60) return;

  // RIGHT ‚Üí BACK
  if(dx>80){
    if(sidebar.classList.contains("show")){closeSidebar();return;}
    if(!blockedBox.classList.contains("hidden")){blockedBox.classList.add("hidden");icon1.classList.remove("rotate");return;}
    if(!totalBox.classList.contains("hidden")){totalBox.classList.add("hidden");icon2.classList.remove("rotate");return;}
    if(document.querySelector(".page.active")?.id==="visitors"){openPage("home");history.pushState({page:"home"},"","");}
  }

  // LEFT ‚Üí OPEN
  if(dx<-80){
    if(!sidebar.classList.contains("show")){sidebar.classList.add("show");overlay.classList.add("show");return;}
    if(document.querySelector(".page.active")?.id==="home"){openPage("visitors");history.pushState({page:"visitors"},"","");}
  }
});
</script>

</body>
</html>
